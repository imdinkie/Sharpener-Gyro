<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Knife Angle Settings</title>
  <style>
    :root {
      --bg: #0b0c10;
      --card: #111318;
      --fg: #e5e7eb;
      --muted: #9ca3af;
      --accent: #60a5fa;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at 20% 20%, rgba(96,165,250,0.08), transparent 32%), var(--bg);
      color: var(--fg);
      font: 16px/1.25 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      display: grid;
      place-items: center;
      min-height: 100vh;
      padding: 24px 12px 32px;
    }
    .wrap { width: 100%; max-width: 760px; }
    .card {
      background: var(--card);
      border-radius: 18px;
      box-shadow: 0 16px 60px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,0.03);
      padding: 22px;
      display: grid;
      gap: 18px;
    }
    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
    .title { font-size: 22px; font-weight: 800; letter-spacing: .02em; }
    .link { color: var(--muted); text-decoration: none; font-weight: 700; }
    .field { display: grid; gap: 8px; }
    .field-label { font-size: 12px; color: var(--muted); letter-spacing: .08em; text-transform: uppercase; }
    .field-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input[type="number"] {
      width: 120px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #1f2430;
      background: #0f1116;
      color: var(--fg);
      outline: none;
      font-weight: 700;
      text-align: right;
    }
    input[type="number"]:focus {
      border-color: #334155;
      box-shadow: 0 0 0 4px rgba(96,165,250,.2);
    }
    .mode-toggle {
      display: flex;
      gap: 6px;
      background: #0f1116;
      border-radius: 14px;
      border: 1px solid #1f2430;
      padding: 6px;
    }
    .mode-btn {
      flex: 1;
      border: 0;
      border-radius: 12px;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      padding: 10px 0;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .mode-btn.active {
      background: var(--accent);
      color: #050a15;
      box-shadow: 0 10px 28px rgba(96, 165, 250, .35);
    }
    button {
      padding: 12px 16px;
      border-radius: 12px;
      border: 0;
      background: var(--accent);
      color: #0b1220;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 10px 28px rgba(96,165,250,0.25);
    }
    .toggle-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .toggle-row label { font-weight: 700; color: var(--fg); }
    .muted { color: var(--muted); font-size: 13px; }
    .status { font-size: 12px; color: var(--muted); min-height: 16px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <a class="link" href="/">&larr; Back</a>
        <div class="title">Settings</div>
      </div>

      <div class="field">
        <span class="field-label">Angle Mode</span>
        <div class="mode-toggle" role="group" aria-label="Angle mode selector">
          <button type="button" class="mode-btn" data-mode-option="PITCH" aria-pressed="false">Pitch</button>
          <button type="button" class="mode-btn" data-mode-option="ROLL" aria-pressed="false">Roll</button>
          <button type="button" class="mode-btn" data-mode-option="YAW" aria-pressed="false">Yaw</button>
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <span class="field-label">Target angle</span>
          <div class="field-row">
            <input id="target" type="number" step="0.1" value="20"><span>째</span>
          </div>
          <span class="muted">Used for deviation/alarm calculations.</span>
        </div>
        <div class="field">
          <span class="field-label">Deadband / Critical / Silence</span>
          <div class="field-row">
            <label class="field-row" style="gap:4px;">
              <span class="muted">Deadband</span>
              <input id="deadband" type="number" step="0.1" min="0" max="30" value="1"><span>째</span>
            </label>
            <label class="field-row" style="gap:4px;">
              <span class="muted">Critical</span>
              <input id="critical" type="number" step="0.1" min="0" max="60" value="4"><span>째</span>
            </label>
            <label class="field-row" style="gap:4px;">
              <span class="muted">Silence &gt;</span>
              <input id="silence" type="number" step="0.1" min="0" max="90" value="10"><span>째</span>
            </label>
          </div>
        </div>
      </div>

      <div class="toggle-row">
        <label for="showChartToggle">Show stability chart on main page</label>
        <input id="showChartToggle" type="checkbox">
      </div>
      <div class="toggle-row">
        <label for="showMeanToggle">Show over/under marker & text</label>
        <input id="showMeanToggle" type="checkbox">
      </div>
      <div class="toggle-row">
        <label for="useSseToggle">Use live streaming (SSE) instead of polling</label>
        <input id="useSseToggle" type="checkbox">
      </div>
      <div class="field">
        <span class="field-label">Angle & audio smoothing</span>
        <div class="field-row">
          <input id="displaySmoothing" type="range" min="0.05" max="0.9" step="0.05" value="0.25">
          <span class="muted" id="displaySmoothingVal">0.25</span>
        </div>
        <span class="muted">Used for the live angle readout and sounds.</span>
      </div>
      <div class="field">
        <span class="field-label">Chart smoothing</span>
        <div class="field-row">
          <input id="smoothing" type="range" min="0.05" max="0.9" step="0.05" value="0.3">
          <span class="muted" id="smoothingVal">0.30</span>
        </div>
        <span class="muted">Lower = smoother/slower, higher = more responsive/jiggly.</span>
      </div>
      <div class="muted">Hide markers/text for a cleaner chart.</div>

      <div class="row" style="justify-content: flex-end;">
        <button id="saveBtn" type="button">Save</button>
      </div>
      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEYS = {
      target: "sharpener.target",
      deadband: "sharpener.deadband",
      critical: "sharpener.critical",
      silence: "sharpener.silence",
      chartSmoothing: "sharpener.chartSmoothing",
      displaySmoothing: "sharpener.displaySmoothing",
    };
    const SHOW_CHART_KEY = "sharpener.showChart";
    const SHOW_MEAN_KEY = "sharpener.showMeanMarkers";
    const USE_SSE_KEY = "sharpener.useSSE";
    const DEFAULTS = {
      target: 20,
      deadband: 1,
      critical: 4,
      silence: 10,
      chartSmoothing: 0.3,
      displaySmoothing: 0.25,
    };
    const MODE_CHOICES = ["PITCH", "ROLL", "YAW"];
    const MODE_STORAGE_KEY = "sharpener.angleMode";
    const MIN_CRITICAL_MARGIN = 0.1;
    const MIN_SILENCE_MARGIN = 0.5;

    const targetIn = document.getElementById("target");
    const deadbandIn = document.getElementById("deadband");
    const criticalIn = document.getElementById("critical");
    const silenceIn = document.getElementById("silence");
    const showChartToggle = document.getElementById("showChartToggle");
    const showMeanToggle = document.getElementById("showMeanToggle");
    const useSseToggle = document.getElementById("useSseToggle");
    const smoothingIn = document.getElementById("smoothing");
    const smoothingVal = document.getElementById("smoothingVal");
    const displaySmoothingIn = document.getElementById("displaySmoothing");
    const displaySmoothingVal = document.getElementById("displaySmoothingVal");
    const modeButtons = Array.from(document.querySelectorAll("[data-mode-option]"));
    const statusEl = document.getElementById("status");

    let target = DEFAULTS.target;
    let deadband = DEFAULTS.deadband;
    let critical = DEFAULTS.critical;
    let silence = DEFAULTS.silence;
    let angleMode = null;
    let modeInflight = false;

    const sanitizeModeName = (value) => {
      if (typeof value !== "string") return null;
      const upper = value.trim().toUpperCase();
      return MODE_CHOICES.includes(upper) ? upper : null;
    };
    const sanitizeTarget = (v) => {
      const val = isFinite(v) && v > 0 ? Math.min(Math.abs(v), 90) : DEFAULTS.target;
      return val;
    };
    const sanitizeDeadband = (v) => {
      const val = isFinite(v) && v >= 0 ? Math.min(Math.abs(v), 30) : DEFAULTS.deadband;
      return val;
    };
    const sanitizeCritical = (v, currentDeadband) => {
      const base = isFinite(v) && v > 0 ? Math.min(Math.abs(v), 60) : DEFAULTS.critical;
      const minAllowed = (isFinite(currentDeadband) ? currentDeadband : DEFAULTS.deadband) + MIN_CRITICAL_MARGIN;
      return Math.max(minAllowed, base);
    };
    const sanitizeSilence = (v, currentCritical) => {
      const base = isFinite(v) && v > 0 ? Math.min(Math.abs(v), 90) : DEFAULTS.silence;
      const minAllowed = (isFinite(currentCritical) ? currentCritical : DEFAULTS.critical) + MIN_SILENCE_MARGIN;
      return Math.max(minAllowed, base);
    };
    const sanitizeSmoothing = (v, fallback = DEFAULTS.chartSmoothing) => {
      const base = isFinite(v) ? v : fallback;
      return Math.min(0.9, Math.max(0.05, base));
    };
    const loadSetting = (key, fallback) => {
      try {
        const raw = localStorage.getItem(key);
        if (raw === null) return fallback;
        const val = parseFloat(raw);
        return isFinite(val) ? val : fallback;
      } catch (_) {
        return fallback;
      }
    };
    const persistSetting = (key, value) => {
      try { localStorage.setItem(key, String(value)); } catch (_) {}
    };
    const loadChartPreference = () => {
      try {
        const raw = localStorage.getItem(SHOW_CHART_KEY);
        if (raw === null) return true;
        return raw === "1" || raw === "true";
      } catch (_) {
        return true;
      }
    };
    const loadChartSmoothing = () => {
      const raw = loadSetting(STORAGE_KEYS.chartSmoothing, DEFAULTS.chartSmoothing);
      return sanitizeSmoothing(raw, DEFAULTS.chartSmoothing);
    };
    const loadDisplaySmoothing = () => {
      const raw = loadSetting(STORAGE_KEYS.displaySmoothing, DEFAULTS.displaySmoothing);
      return sanitizeSmoothing(raw, DEFAULTS.displaySmoothing);
    };
    const loadMeanPreference = () => {
      try {
        const raw = localStorage.getItem(SHOW_MEAN_KEY);
        if (raw === null) return true;
        return raw === "1" || raw === "true";
      } catch (_) {
        return true;
      }
    };
    const loadSsePreference = () => {
      try {
        const raw = localStorage.getItem(USE_SSE_KEY);
        if (raw === null) return true;
        return raw === "1" || raw === "true";
      } catch (_) {
        return true;
      }
    };
    const persistChartPreference = (show) => {
      try { localStorage.setItem(SHOW_CHART_KEY, show ? "1" : "0"); } catch (_) {}
    };
    const persistMeanPreference = (show) => {
      try { localStorage.setItem(SHOW_MEAN_KEY, show ? "1" : "0"); } catch (_) {}
    };
    const persistChartSmoothing = (val) => {
      const v = sanitizeSmoothing(val, DEFAULTS.chartSmoothing);
      persistSetting(STORAGE_KEYS.chartSmoothing, v);
      if (smoothingVal) smoothingVal.textContent = v.toFixed(2);
    };
    const persistDisplaySmoothing = (val) => {
      const v = sanitizeSmoothing(val, DEFAULTS.displaySmoothing);
      persistSetting(STORAGE_KEYS.displaySmoothing, v);
      if (displaySmoothingVal) displaySmoothingVal.textContent = v.toFixed(2);
    };

    function updateModeButtons(mode) {
      if (!modeButtons.length) return;
      const normalized = sanitizeModeName(mode);
      modeButtons.forEach(btn => {
        const btnMode = sanitizeModeName(btn.dataset.modeOption);
        const active = Boolean(normalized && btnMode === normalized);
        btn.classList.toggle("active", active);
        btn.setAttribute("aria-pressed", active ? "true" : "false");
      });
    }

    function applyModeSelection(mode) {
      const normalized = sanitizeModeName(mode);
      angleMode = normalized;
      if (normalized) localStorage.setItem(MODE_STORAGE_KEY, normalized);
      updateModeButtons(normalized);
    }

    async function syncModeFromServer() {
      try {
        const res = await fetch("/angle-mode", { cache: "no-store" });
        if (!res || !res.ok) return;
        const data = await res.json();
        const serverMode = sanitizeModeName(data && data.mode);
        if (serverMode) {
          applyModeSelection(serverMode);
        }
      } catch (_) {}
    }

    async function requestModeChange(nextMode) {
      const desired = sanitizeModeName(nextMode);
      if (!desired || modeInflight) return;
      if (desired === angleMode) return;
      modeInflight = true;
      updateModeButtons(desired);
      try {
        const res = await fetch("/angle-mode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode: desired }),
        });
        if (res && res.ok) {
          const data = await res.json();
          const serverMode = sanitizeModeName(data && data.mode);
          if (serverMode) {
            applyModeSelection(serverMode);
          } else {
            updateModeButtons(angleMode);
          }
        } else {
          updateModeButtons(angleMode);
        }
      } catch (_) {
        updateModeButtons(angleMode);
      } finally {
        modeInflight = false;
      }
    }

    function initSettingsUI() {
      target = sanitizeTarget(loadSetting(STORAGE_KEYS.target, DEFAULTS.target));
      deadband = sanitizeDeadband(loadSetting(STORAGE_KEYS.deadband, DEFAULTS.deadband));
      critical = sanitizeCritical(loadSetting(STORAGE_KEYS.critical, DEFAULTS.critical), deadband);
      silence = sanitizeSilence(loadSetting(STORAGE_KEYS.silence, DEFAULTS.silence), critical);
      const chartSmooth = loadChartSmoothing();
      const displaySmooth = loadDisplaySmoothing();
      const useSse = loadSsePreference();

      targetIn.value = target;
      deadbandIn.value = deadband;
      criticalIn.value = critical;
      silenceIn.value = silence;
      showChartToggle.checked = loadChartPreference();
      showMeanToggle.checked = loadMeanPreference();
      if (useSseToggle) {
        useSseToggle.checked = useSse;
      }
      if (displaySmoothingIn) {
        displaySmoothingIn.value = displaySmooth;
        displaySmoothingVal.textContent = displaySmooth.toFixed(2);
      }
      if (smoothingIn) {
        smoothingIn.value = chartSmooth;
        smoothingVal.textContent = chartSmooth.toFixed(2);
      }
    }

    function persistAll() {
      persistSetting(STORAGE_KEYS.target, target);
      persistSetting(STORAGE_KEYS.deadband, deadband);
      persistSetting(STORAGE_KEYS.critical, critical);
      persistSetting(STORAGE_KEYS.silence, silence);
      persistChartPreference(showChartToggle.checked);
      persistMeanPreference(showMeanToggle.checked);
      if (useSseToggle) {
        try {
          localStorage.setItem(USE_SSE_KEY, useSseToggle.checked ? "1" : "0");
        } catch (_) {}
      }
      if (smoothingIn) persistChartSmoothing(parseFloat(smoothingIn.value));
      if (displaySmoothingIn) persistDisplaySmoothing(parseFloat(displaySmoothingIn.value));
      statusEl.textContent = "Saved locally. The main page will sync shortly.";
    }

    modeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const btnMode = sanitizeModeName(btn.dataset.modeOption);
        if (btnMode) requestModeChange(btnMode);
      });
    });

    targetIn.addEventListener("change", () => {
      const v = parseFloat(targetIn.value);
      target = sanitizeTarget(v);
      targetIn.value = target;
    });
    deadbandIn.addEventListener("change", () => {
      const v = parseFloat(deadbandIn.value);
      deadband = sanitizeDeadband(v);
      deadbandIn.value = deadband;
      if (critical <= deadband) {
        critical = sanitizeCritical(critical, deadband);
        criticalIn.value = critical;
        if (silence <= critical) {
          silence = sanitizeSilence(silence, critical);
          silenceIn.value = silence;
        }
      }
    });
    criticalIn.addEventListener("change", () => {
      const v = parseFloat(criticalIn.value);
      critical = sanitizeCritical(v, deadband);
      criticalIn.value = critical;
      if (silence <= critical) {
        silence = sanitizeSilence(silence, critical);
        silenceIn.value = silence;
      }
    });
    silenceIn.addEventListener("change", () => {
      const v = parseFloat(silenceIn.value);
      silence = sanitizeSilence(v, critical);
      silenceIn.value = silence;
    });

    document.getElementById("saveBtn").addEventListener("click", persistAll);
    showChartToggle.addEventListener("change", () => persistChartPreference(showChartToggle.checked));
    showMeanToggle.addEventListener("change", () => persistMeanPreference(showMeanToggle.checked));
    displaySmoothingIn.addEventListener("input", () => {
      const v = sanitizeSmoothing(parseFloat(displaySmoothingIn.value));
      displaySmoothingVal.textContent = v.toFixed(2);
    });
    smoothingIn.addEventListener("input", () => {
      const v = sanitizeSmoothing(parseFloat(smoothingIn.value));
      smoothingVal.textContent = v.toFixed(2);
    });

    initSettingsUI();
    applyModeSelection(localStorage.getItem(MODE_STORAGE_KEY));
    syncModeFromServer();
  </script>
</body>
</html>
